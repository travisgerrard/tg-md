<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>The List</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="./style.css">

	</head>
	<body>
		<div id="main"></div>

		<script type="text/babel">

    var PatientGeneral = React.createClass({
			getInitialState() {
					return {
						dob: (this.props.patientData.dob === undefined) ? "" : this.decodeString(this.props.patientData.dob),
						admitDate: this.props.patientData.los,
					}
				},

			decodeString: function(stringToDecode) {
				var decodedString = CryptoJS.AES.decrypt(stringToDecode, this.props.secretCode).toString(CryptoJS.enc.Utf8);
				return decodedString;
			},

			calcAge: function(dob) {
				var birthdate = new Date(dob);
				var cur = new Date();
				var diff = cur-birthdate;
				var age = Math.floor(diff/31536000000);
				return age;
			},

			calcDays: function(admitDate) {
				var one_day=1000*60*60*24;
				var startDate = new Date(admitDate);
				var cur = new Date();
				var diff = cur-startDate;
				var days = Math.floor(diff/one_day);
				return days;
			},

			handleChange: function(event) {
				this.props.onUpdate(event.target, this.props.patientData._id);

				if (event.target.className === "DOB") this.setState({ dob: event.target.value});
				if (event.target.className === "LOS") this.setState({ admitDate: event.target.value});

			},

      render: function() {
        return (
        <div>
        <label id="PatientGen">Name:</label>
        <input id="PatientInput" type="text" className="Name" onChange={this.handleChange} defaultValue={(this.props.patientData.name === undefined) ? "" : this.decodeString(this.props.patientData.name)} />
        <br  />
        <label id="PatientGen">Room:</label>
        <input id="PatientInput" type="text" className="Room" onChange={this.handleChange} defaultValue={this.props.patientData.room}/>
        <br  />
        <label id="PatientGen">DOB:</label>
        <input id="PatientInput" type="text" className="DOB" onChange={this.handleChange} defaultValue={(this.props.patientData.dob === undefined) ? "" : this.decodeString(this.props.patientData.dob)}/>
				<br />
				<label>Age: {this.calcAge(this.state.dob)}</label>
        <br  />
        <label id="PatientGen">MRN:</label>
        <input id="PatientInput" type="text" className="MRN" onChange={this.handleChange} defaultValue={(this.props.patientData.mrn === undefined) ? "" : this.decodeString(this.props.patientData.mrn)}/>
        <br  />
        <label id="PatientGen">Admit:</label>
        <input id="PatientInput" type="text" className="LOS" onChange={this.handleChange} defaultValue={this.props.patientData.los}/>
				<br />
				<label>Day: {this.calcDays(this.state.admitDate)}</label>
				<br  />
				<label id="PatientGen">RO:</label>
				<input id="PatientInput" type="text" className="RO" onChange={this.handleChange} defaultValue={this.props.patientData.ro}/>
        </div>
				)
      }
    })

		var PatientLabs = React.createClass({
			getInitialState() {
			    return {
			      input: this.props.patientData.input,
			      output: this.props.patientData.output,
			    }
			  },

			handleChange: function(event) {
				this.props.onUpdate(event.target, this.props.patientData._id);

				if (event.target.className === "Input") this.setState({ input: event.target.value});
				if (event.target.className === "Output") this.setState({ output: event.target.value});

			},

			render: function() {
				return (
					<div id="cbcAndBmr">
					<div id="parentTop">
							<input type="text" id="textInputLower" className="WBC" onChange={this.handleChange} defaultValue={this.props.patientData.wbc}/>
							<label>\</label>
							<input type="text" id="underlineInput" className="Hg" onChange={this.handleChange} defaultValue={this.props.patientData.hg}/>
							<label>/</label>
					</div>
					<div id="parentBottom">
							<label>/</label>
							<input type="text" className="Hct" onChange={this.handleChange} defaultValue={this.props.patientData.hct}/>
							<label>\</label>
							<input type="text" id="edgeBoxBottom" className="plt" onChange={this.handleChange} defaultValue={this.props.patientData.plt}/>
					</div>
					<br />
					<div id="BMRTop">
							<input type="text" id="underlineInput" className="Na" onChange={this.handleChange} defaultValue={this.props.patientData.na}/>
							<label>|</label>
							<input type="text" id="underlineInput" className="Cl" onChange={this.handleChange} defaultValue={this.props.patientData.cl}/>
							<label>|</label>
							<input type="text" id="underlineInput" className="BUN" onChange={this.handleChange} defaultValue={this.props.patientData.bun}/>
							<label>/</label>
							<input type="text" id="textInputLower" className="Gluc" onChange={this.handleChange} defaultValue={this.props.patientData.gluc}/>
					</div>
					<div id="BMRBottom">
							<input type="text" id="potassium" className="K" onChange={this.handleChange} defaultValue={this.props.patientData.k}/>
							<label>|</label>
							<input type="text" className="Bicarb" onChange={this.handleChange} defaultValue={this.props.patientData.bicarb}/>
							<label>|</label>
							<input type="text" className="Cr" onChange={this.handleChange} defaultValue={this.props.patientData.cr}/>
							<label>\</label>
					</div>
					<br />
					<div id="InAndOut">
						<label>I/O</label>
						<input type="text" id="underlineInput" className="Input" onChange={this.handleChange} defaultValue={this.props.patientData.input}/>
						<label>/</label>
						<input type="text" id="underlineInput" className="Output" onChange={this.handleChange} defaultValue={this.props.patientData.output}/>
						<label>: {this.state.input - this.state.output}</label>
					</div>
					<br />
					<div id="OtherLabs">
						<textarea className="OtherLabs" onChange={this.handleChange} defaultValue={this.props.patientData.otherLabs}/>
					</div>
				</div>
				)
			}
		})

		var dailyTodos = [
			'Consults',
			'Andon - VTE/Glucose',
			'MAR 48',
			'IV Meds',
			'AM Labs',
			'Discharge/Dispo',
			'Learning'];

		var PatientDailyTodo = React.createClass({
			handleChange: function(event) {
				//console.log(event.target.value);
				//console.log(this.props.patientData.consults);
				this.props.onUpdate(event.target, this.props.patientData._id);
			},

			render: function() {
				return (
					<div>
						<ul>
							<li>
								<label>
									<input type="checkbox" className="Consults" value="consult" onChange={this.handleChange} defaultChecked={this.props.patientData.consults} />{this.props.listToRender[0]}
								</label>
							</li>
							<li>
								<label>
								<input type="checkbox" className="Andon" value="andon" onChange={this.handleChange} defaultChecked={this.props.patientData.andon} />{this.props.listToRender[1]}
								</label>
							</li>
							<li>
								<label>
								<input type="checkbox" className="Mar" value="mar" onChange={this.handleChange} defaultChecked={this.props.patientData.mar} />{this.props.listToRender[2]}
								</label>
							</li>
							<li>
								<label>
								<input type="checkbox" className="IVMed" value="ivmed" onChange={this.handleChange} defaultChecked={this.props.patientData.ivmed} />{this.props.listToRender[3]}
								</label>
							</li>
							<li>
								<label>
								<input type="checkbox" className="AMLab" value="amlab" onChange={this.handleChange} defaultChecked={this.props.patientData.amlab} />{this.props.listToRender[4]}
								</label>
							</li>
							<li>
								<label>
								<input type="checkbox" className="Dispo" value="dispo" onChange={this.handleChange} defaultChecked={this.props.patientData.dispo} />{this.props.listToRender[5]}
								</label>
							</li>
							<li>
								<label>
								<input type="checkbox" className="Learning" value="learning" onChange={this.handleChange} defaultChecked={this.props.patientData.learning} />{this.props.listToRender[6]}
								</label>
							</li>
						</ul>
					</div>
				)
			}
		})

		var PatientFollowUps = React.createClass({
			decodeString: function(stringToDecode) {
				var decodedString = CryptoJS.AES.decrypt(stringToDecode, this.props.secretCode).toString(CryptoJS.enc.Utf8);
				return decodedString;
			},

			handleChange: function(event) {
				//console.log(event);
				//using the name field to get at the key value of the
				//console.log(event.target.name);
				//console.log(this.props.patientData.followup[event.target.name]);
				//console.log(this.props.patientData.consults);
				this.props.onUpdate(event.target, this.props.patientData._id);
			},

			_handleKeyPress: function(e) {
				if (e.key === 'Enter') {
					this.props.onUpdate(e.target, this.props.patientData._id);
					e.currentTarget.value = ""
				}
			},

			handelDelete: function(event) {
				//console.log(event.target.name);
				this.props.onUpdate(event.target, this.props.patientData._id);
			},

			render: function() {
				//console.log(this.props.patientData.followup);
				if (this.props.patientData.followup !== undefined) {
				return (
					<div>
					<label>Follow Ups</label>
					<br />
					<input type="text" className="AddFollowUp" onKeyPress={this._handleKeyPress} />
						<ul id="followUpUl">
							{this.props.patientData.followup.map((element, key) =>
								<li key={element.followUpText} id="followUpLi">
								<input type="checkbox" className="FollowUp" name={key} value={this.decodeString(element.followUpText)} onChange={this.handleChange} defaultChecked={element.complete} />{this.decodeString(element.followUpText)}
								<a className="deleteFollowUp" name={key} onClick={this.handelDelete}>{element.complete ? "_X_" : ""}</a>
								</li>
							)}
						</ul>
					</div>
				)
				} else {
				return (
					<div>
					<label>Follow Ups</label>
					<br />
					<input type="text" className="AddFollowUp" onKeyPress={this._handleKeyPress} />
					</div>
				)
				}
			}
		})

		var PatientLearning = React.createClass({
			decodeString: function(stringToDecode) {
				var decodedString = CryptoJS.AES.decrypt(stringToDecode, this.props.secretCode).toString(CryptoJS.enc.Utf8);
				return decodedString;
			},

			handleChange: function(event) {
				//console.log(event);
				//using the name field to get at the key value of the
				//console.log(event.target.name);
				//console.log(this.props.patientData.followup[event.target.name]);
				//console.log(this.props.patientData.consults);
				this.props.onUpdate(event.target, this.props.patientData._id);
			},

			_handleKeyPress: function(e) {
				if (e.key === 'Enter') {
					this.props.onUpdate(e.target, this.props.patientData._id);
					e.currentTarget.value = ""
				}
			},

			handelDelete: function(event) {
				//console.log(event.target.name);
				this.props.onUpdate(event.target, this.props.patientData._id);
			},

			handleDeletePatient: function(event) {
				console.log("deletes a patient");
			},

			render: function() {
				if (this.props.patientData.learningList !== undefined) {
				return (
					<div>
					<label>Learning</label>
					<br />
					<input type="text" className="AddLearning" onKeyPress={this._handleKeyPress} />
						<ul id="followUpUl">
							{this.props.patientData.learningList.map((element, key) =>
								<li key={element.learningText} id="followUpLi">
								<input type="checkbox" className="LearningList" name={key} value={this.decodeString(element.learningText)} onChange={this.handleChange} defaultChecked={element.complete} />{this.decodeString(element.learningText)}
								<a className="deleteLearning" name={key} onClick={this.handelDelete}>{element.complete ? "_X_" : ""}</a>
								</li>
							)}
						</ul>
						<button onClick={this.handleDeletePatient}>Delete Patient</button>

					</div>
				)
				} else {
				return (
					<div>
						<div>
							<label>Learning</label>
							<br />
							<input type="text" className="AddLearning" onKeyPress={this._handleKeyPress} />
						</div>

						<button onClick={this.handleDeletePatient}>Delete Patient</button>

					</div>

					)
				}
			}
		})

    var PatientAll = React.createClass({

			encodeString: function(stringToEncode) {
				var encodedString = CryptoJS.AES.encrypt(stringToEncode, this.props.secretCode).toString();
				return encodedString;
			},

			decodeString: function(stringToDecode) {
				var decodedString = CryptoJS.AES.decrypt(stringToDecode, this.props.secretCode).toString(CryptoJS.enc.Utf8);
				return decodedString;
			},

			onUpdate: function(val, patientID){
				/*
				console.log("val is", val);
				console.log("Entered Text is", val.value);
				console.log("Where it was entered into was", val.className);
				console.log("Patient ID is ", patientID);
				*/

				var patient = {};

				// Standard Info
				if (val.className === "Name") patient = {name: this.encodeString(val.value)};
				if (val.className === "Room") patient = {room: val.value};
				if (val.className === "DOB") patient = {dob: this.encodeString(val.value)};
				if (val.className === "MRN") patient = {mrn: this.encodeString(val.value)};
				if (val.className === "LOS") patient = {los: val.value};
				if (val.className === "RO") patient = {ro: val.value};


				// CBC
				if (val.className === "WBC") patient = {wbc: val.value};
				if (val.className === "Hg") patient = {hg: val.value};
				if (val.className === "Hct") patient = {hct: val.value};
				if (val.className === "plt") patient = {plt: val.value};

				// BMR
				if (val.className === "Na") patient = {na: val.value};
				if (val.className === "K") patient = {k: val.value};
				if (val.className === "Cl") patient = {cl: val.value};
				if (val.className === "Bicarb") patient = {bicarb: val.value};
				if (val.className === "BUN") patient = {bun: val.value};
				if (val.className === "Cr") patient = {cr: val.value};
				if (val.className === "Gluc") patient = {gluc: val.value};

				// I/O
				if (val.className === "Input") patient = {input: val.value};
				if (val.className === "Output") patient = {output: val.value};
				if (val.className === "OtherLabs") patient = {otherLabs: val.value};


				// DailyTodos, using a ternary operator
				if (val.className === "Consults") patient = (this.props.patientData.consults === true) ? {consults: false} : {consults: true};
				if (val.className === "Andon") patient = (this.props.patientData.andon === true) ? {andon: false} : {andon: true};
				if (val.className === "Mar") patient = (this.props.patientData.mar === true) ? {mar: false} : {mar: true};
				if (val.className === "IVMed") patient = (this.props.patientData.ivmed === true) ? {ivmed: false} : {ivmed: true};
				if (val.className === "AMLab") patient = (this.props.patientData.amlab === true) ? {amlab: false} : {amlab: true};
				if (val.className === "Dispo") patient = (this.props.patientData.dispo === true) ? {dispo: false} : {dispo: true};
				if (val.className === "Learning") patient = (this.props.patientData.learning === true) ? {learning: false} : {learning: true};

				// Adding to list of followups, again using ternary operator!
				if (val.className === "AddFollowUp") patient = (this.props.patientData.followup === undefined) ? {followup: [{complete: false, followUpText: this.encodeString(val.value), hidden: false}]} : {followup: this.props.patientData.followup.concat({complete: false, followUpText: this.encodeString(val.value), hidden: false})};

				// checking off a followup
				if (val.className === "FollowUp") {
					var tempArray = this.props.patientData.followup.concat();
					var object = tempArray[val.name];
					object = (object.complete === true) ? object.complete = false : object.complete = true;
					//console.log(tempArray);
					patient = {followup: tempArray};
				}

				// deleting a followup
				if (val.className === "deleteFollowUp") {
					var tempArray = this.props.patientData.followup.concat();
					tempArray.splice(val.name, 1);
					patient = {followup: tempArray};
				}

				// Adding to list of learning, again using ternary operator!
				if (val.className === "AddLearning") patient = (this.props.patientData.learningList === undefined) ? {learningList: [{complete: false, learningText: this.encodeString(val.value), hidden: false}]} : {learningList: this.props.patientData.learningList.concat({complete: false, learningText: this.encodeString(val.value), hidden: false})};

				// checking off a learning
				if (val.className === "LearningList") {
					var tempArray = this.props.patientData.learningList.concat();
					var object = tempArray[val.name];
					object = (object.complete === true) ? object.complete = false : object.complete = true;
					//console.log(tempArray);
					patient = {learningList: tempArray};
				}

				// deleting a learning
				if (val.className === "deleteLearning") {
					var tempArray = this.props.patientData.learningList.concat();
					tempArray.splice(val.name, 1);
					patient = {learningList: tempArray};
				}

		    $.ajax({
		      url: this.props.url + patientID, type: 'PUT', contentType:'application/json',
		      data: JSON.stringify(patient),
		      dataType: 'json',
		      success: function(patient) {
						//Update the state if were clicking a checkbox
						if (val.className === "Consults" ||
							val.className === "Andon" ||
							val.className === "Mar" ||
							val.className === "IVMed" ||
							val.className === "AMLab" ||
							val.className === "Dispo" ||
							val.className === "Learning" ||
							val.className === "AddFollowUp" ||
							val.className === "FollowUp" ||
							val.className === "deleteFollowUp" ||
							val.className === "AddLearning" ||
							val.className === "Learning" ||
							val.className === "deleteLearning") this.props.updateTheState();
		      }.bind(this),
		    });
			},

			render: function() {

		    return (
					<div className="flex-grid">
						<div className="col">
              <PatientGeneral onUpdate={this.onUpdate} patientData={this.props.patientData} secretCode={this.props.secretCode}/>
						</div>
						<div className="col">
							<PatientLabs onUpdate={this.onUpdate} patientData={this.props.patientData}/>
						</div>
						<div className="col">
							<PatientDailyTodo listToRender={dailyTodos} onUpdate={this.onUpdate} patientData={this.props.patientData}/>
						</div>
						<div className="col">
							<PatientFollowUps onUpdate={this.onUpdate} patientData={this.props.patientData} secretCode={this.props.secretCode} />
						</div>
						<div className="col">
							<PatientLearning onUpdate={this.onUpdate} patientData={this.props.patientData} secretCode={this.props.secretCode} />
						</div>
					</div>
		    )
		  }
		});

		var PatientAllList = React.createClass({

			//var webSiteConnect = 'http://a58d4232.ngrok.io/api/runTheList/';
			//var webSiteConnect = 'http://localhost:3000/api/runTheList';

			encodeString: function(stringToEncode, secretCode) {
				var encodedString = CryptoJS.AES.encrypt(stringToEncode, secretCode).toString();
				return encodedString;
			},

			decodeString: function(stringToDecode, secretCode) {
				var decodedString = CryptoJS.AES.decrypt(stringToDecode, secretCode).toString(CryptoJS.enc.Utf8);
				return decodedString;
			},

			getInitialState: function() {
					return {
						patients: [],
						secretCode: 'frisky', //Should be null when using for production
						step: 2,
						webSiteConnect: 'http://a58d4232.ngrok.io/api/runTheList/', //Should be one when using for production
					}
				},

				_handleKeyPress: function(e) {
					if (e.key === 'Enter') {
						this.setState({ secretCode: e.target.value});
						this.setState({	step : this.state.step + 1 });

						var encrypted1 = CryptoJS.AES.encrypt("Secret message", e.target.value);
						var encrypted2 = CryptoJS.AES.encrypt("Secret message", e.target.value).toString();

/*
						console.log(this.encodeString("Secret message", e.target.value));
						console.log(CryptoJS.AES.encrypt("Secret message", e.target.value).toString());
						console.log(CryptoJS.AES.encrypt("Secret message", e.target.value).toString());

						console.log(CryptoJS.AES.decrypt(encrypted1, e.target.value).toString(CryptoJS.enc.Utf8))
						console.log(this.decodeString(encrypted2, e.target.value));
*/
					}
				},

			handleSubmit: function(e) {
					e.preventDefault();
					this.addPatient({hidden: false})
			},

			filterByRoundingOrder: function() {
				$.ajax('http://localhost:3000/api/runTheList?sortByRo=ro').done(function (data) {
					this.setState({ patients: data });
				}.bind(this));
			},

			componentDidMount: function () {
		    $.ajax(this.state.webSiteConnect).done(function (data) {
		      this.setState({ patients: data });
		    }.bind(this));
		  },

			updateTheState: function() {
				$.ajax(this.state.webSiteConnect).done(function (data) {
		      this.setState({ patients: data });
		    }.bind(this));
			},

			addPatient: function(patientToAdd) {
		    console.log("Adding patient:", patientToAdd);
		    $.ajax({
		      type: 'POST', url: this.state.webSiteConnect, contentType: 'application/json',
		      data: JSON.stringify(patientToAdd),
		      success: function(data) {
						console.log("the Data is", data);
		        var patient = data;
		        // We're advised not to modify the state, it's immutable. So, make a copy.
		        var patientsModified = this.state.patients.concat(patient);
		        this.setState({patients: patientsModified});
		      }.bind(this),
		      error: function(xhr, status, err) {
		        // ideally, show error to user.
		        console.log("Error adding pateint:", err);
		      }
		    });
		  },

			render: function() {
				switch (this.state.step) {
					case 1:
					return (
						<div>
							<input type="text" className="SecretCodeInput" onKeyPress={this._handleKeyPress} />
						</div>
					)
					case 2:
						if (this.state.patients === undefined || this.state.patients.length == 0) {
							return (
								<button onClick={this.handleSubmit} className="btn btn-primary center-block">Add Patient</button>
							)
						} else {
							return (
								<div>
								<ul>
									{this.state.patients.map(element => <li key={element._id}><PatientAll patientData={element} updateTheState={this.updateTheState} secretCode={this.state.secretCode} url={this.state.webSiteConnect}/><br /><hr /></li>)}
								</ul>
								<button onClick={this.handleSubmit} className="btn btn-primary center-block">Add Patient</button>
								</div>
							)
						}
					}
			}
		});

		var formRendered = ReactDOM.render(
		  <PatientAllList />,
		  document.getElementById('main')
		);
		</script>
	</body>
</html>
